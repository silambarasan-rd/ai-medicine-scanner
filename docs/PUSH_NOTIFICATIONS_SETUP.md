# Push Notification Setup Guide

Complete guide for medicine reminder push notifications using **Supabase + Web Push + cron-job.org**.

## Technology Stack

- **Web Push API** - Native browser push notifications (no Firebase/third-party needed)
- **Supabase Edge Functions** - Send notifications using `npm:web-push` library
- **cron-job.org** - Reliable cron scheduler (runs every minute)
- **Service Worker** - Client-side notification handling
- **PostgreSQL** - Queue management with automatic triggers

## Prerequisites

- Supabase project with database
- GitHub repository with Actions enabled
- Web Push VAPID keys

## Step 1: Generate VAPID Keys

VAPID (Voluntary Application Server Identification) keys are required for Web Push notifications.

```bash
# Install web-push globally
npm install -g web-push

# Generate VAPID keys
web-push generate-vapid-keys
```

This will output:
```
=======================================
Public Key: <your-public-key>
Private Key: <your-private-key>
=======================================
```

## Step 2: Set Environment Variables

Add the following to your `.env.local` file:

```env
# Push Notification VAPID Keys
NEXT_PUBLIC_VAPID_PUBLIC_KEY=<your-public-key>
VAPID_PRIVATE_KEY=<your-private-key>
VAPID_SUBJECT=mailto:your-email@example.com
```

For Supabase Edge Functions, add these secrets:

```bash
supabase secrets set VAPID_PUBLIC_KEY="<your-public-key>"
supabase secrets set VAPID_PRIVATE_KEY="<your-private-key>"
supabase secrets set VAPID_SUBJECT="mailto:your-email@example.com"
```

## Step 3: Apply Database Migrations

Run the migration to create notification tables:

```bash
supabase db push
```

This will create:
- `push_subscriptions` - Stores user push notification subscriptions
- `medicine_confirmations` - Tracks medicine intake confirmations
- `notification_queue` - Queue of pending notifications

## Step 4: Deploy Edge Function

The edge function uses **real web-push** (not a mock) with the `npm:web-push@3.6.7` library.

```bash
supabase functions deploy send-medicine-notifications
```

**What it does:**
- Queries `notification_queue` for pending notifications
- Calculates send time: `scheduled_datetime - minutes_before`
- Filters notifications within 2-minute window
- Sends via `webpush.sendNotification()` with VAPID authentication
- Generates next occurrence for recurring medicines (after confirmation sent)
- Marks notifications as sent
- Handles invalid subscriptions (410 Gone)

## Step 5: Setup Cron Job

Use **cron-job.org** for reliable every-minute scheduling (more reliable than GitHub Actions).

**See detailed setup instructions:** [docs/CRON_JOB_SETUP.md](./CRON_JOB_SETUP.md)

**Quick summary:**
1. Sign up at [cron-job.org](https://cron-job.org)
2. Create cron job:
   - **URL**: `https://nzdjcjkrcjgihyfdlsus.supabase.co/functions/v1/send-medicine-notifications`
   - **Schedule**: `* * * * *` (every minute)
   - **Header**: `Authorization: Bearer <service-role-key>`
3. Enable job and monitor execution history

### How It Works

```
Every minute:
  cron-job.org triggers
    ↓
  Calls your Edge Function
    ↓
  Edge Function processes notification queue
    ↓
  Sends push notifications
    ↓
  Updates notification_queue table
    ↓
  Generates next occurrence for recurring medicines
```

## Step 6: Test End-to-End

1. **Enable notifications** in dashboard (toggle button)
2. **Add a test medicine** scheduled 2 minutes in future (timezone auto-detected)
3. **Wait** - cron-job.org will trigger edge function every minute
4. **Notification appears** on your device
5. **Click notification** → Opens dashboard with modal
6. **Confirm intake** → Saved to database
7. **Calendar updates** with ✓ or ✗

## Notification Timing

- **After-meal**: Reminder 30 mins before + confirmation at exact time
- **Before-meal**: Reminder 15 mins before + confirmation at exact time
- **Timezone-aware**: User timezone detected and converted to UTC for accurate scheduling

## Database Tables

```sql
push_subscriptions      # Device subscriptions
medicine_confirmations  # Intake history
notification_queue      # Pending notifications (auto-generated by trigger)
```

## Troubleshooting

**No notifications?**
- Check browser permissions (macOS: System Settings → Notifications → Chrome)
- Verify VAPID keys match between `.env.local` and Supabase secrets
- Check cron-job.org execution history for errors
- Verify subscription exists: `SELECT * FROM push_subscriptions WHERE user_id = '<your-id>'`
- Check timezone: Ensure medicine has correct timezone set

**Edge function errors?**
- Check Supabase function logs: `supabase functions logs send-medicine-notifications`
- Verify secrets are set: `supabase secrets list`
- Test manually: `curl -X POST <edge-function-url> -H "Authorization: Bearer <service-role-key>"`

**Calendar not updating?**
- Check `/api/confirmations` endpoint
- Verify RLS policies allow user access
- Check browser console for errors

**Timezone issues?**
- See [docs/TIMEZONE_FIX.md](./TIMEZONE_FIX.md) for detailed explanation
- Verify timezone column: `SELECT timezone FROM user_medicines`
- Update existing medicines: Add timezone via UI or SQL update

## Checklist

- [ ] Generate VAPID keys
- [ ] Set environment variables
- [ ] Apply database migrations
- [ ] Deploy edge function
- [ ] Set up cron-job.org (see CRON_JOB_SETUP.md)
- [ ] Test on multiple devices
- [ ] Monitor notification delivery rates
- [ ] Enable browser notification permissions

## References

- [Web Push Protocol](https://datatracker.ietf.org/doc/html/rfc8030)
- [VAPID Specification](https://datatracker.ietf.org/doc/html/rfc8292)
- [Service Workers API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Notifications API](https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API)
