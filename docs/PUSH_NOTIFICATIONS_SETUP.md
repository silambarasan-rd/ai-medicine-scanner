# Push Notification Setup Guide

Complete guide for medicine reminder push notifications using **Supabase + Web Push + GitHub Actions**.

## Technology Stack

- **Web Push API** - Native browser push notifications (no Firebase/third-party needed)
- **Supabase Edge Functions** - Send notifications using `npm:web-push` library
- **GitHub Actions** - Cron scheduler (runs every minute)
- **Service Worker** - Client-side notification handling
- **PostgreSQL** - Queue management with automatic triggers

## Prerequisites

- Supabase project with database
- GitHub repository with Actions enabled
- Web Push VAPID keys

## Step 1: Generate VAPID Keys

VAPID (Voluntary Application Server Identification) keys are required for Web Push notifications.

```bash
# Install web-push globally
npm install -g web-push

# Generate VAPID keys
web-push generate-vapid-keys
```

This will output:
```
=======================================
Public Key: <your-public-key>
Private Key: <your-private-key>
=======================================
```

## Step 2: Set Environment Variables

Add the following to your `.env.local` file:

```env
# Push Notification VAPID Keys
NEXT_PUBLIC_VAPID_PUBLIC_KEY=<your-public-key>
VAPID_PRIVATE_KEY=<your-private-key>
VAPID_SUBJECT=mailto:your-email@example.com
```

For Supabase Edge Functions, add these secrets:

```bash
supabase secrets set VAPID_PUBLIC_KEY="<your-public-key>"
supabase secrets set VAPID_PRIVATE_KEY="<your-private-key>"
supabase secrets set VAPID_SUBJECT="mailto:your-email@example.com"
```

## Step 3: Apply Database Migrations

Run the migration to create notification tables:

```bash
supabase db push
```

This will create:
- `push_subscriptions` - Stores user push notification subscriptions
- `medicine_confirmations` - Tracks medicine intake confirmations
- `notification_queue` - Queue of pending notifications

## Step 4: Deploy Edge Function

The edge function uses **real web-push** (not a mock) with the `npm:web-push@3.6.7` library.

```bash
supabase functions deploy send-medicine-notifications
```

**What it does:**
- Queries `GitHub Actions Cron (Already Configured)

The workflow file exists at `.github/workflows/medicine-notifications.yml`

**Required GitHub Secrets** (add in repository settings):
- `SUPABASE_PROJECT_REF` - Your project reference
- `SUPABASE_SERVICE_ROLE_KEY` - Service role key from Supabase

**Workflow features:**
- âœ… Runs every minute (`cron: '* * * * *'`)
- âœ… Calls edge function via HTTP POST
- âœ… Captures response and logs
- âœ… Exits with error code on failure

This workflow:
- âœ… Runs every minute
- âœ… Calls your Edge Function
- âœ… Logs execution details
- âœ… Handles errors gracefully

**Verify the workflow is working:**
1. Go to **GitHub** â†’ **Actions** tab
2. Select **ðŸ”” Send Medicine Notifications**
3. You should see recent runs listed
4. Click on a run to see logs

### Step 5C: Manual Test (Optional)

To test immediately without waiting for the scheduled time:

1. Go to **GitHub** â†’ **Actions** tab
2. Select **ðŸ”” Send Medicine Notifications**
3. Click **Run workflow** â†’ **Run workflow**
4. Check the logs after ~30 seconds

### How It Works

```
Every minute:
  GitHub Actions triggers
    â†“
  Calls your Edge Function
    â†“
  Edge Function processes notification queue
    â†“
  Sends push notifications
    â†“
  Updates notification_queue table
```

## Step 6: Test End-to-End

1. **Enable notifications** in dashboard (toggle button)
2. **Add a test medicine** scheduled 2 minutes in future
3. **Wait** - GitHub Actions will trigger edge function every minute
4. **Notification appears** on your device
5. **Click notification** â†’ Opens dashboard with modal
6. **Confirm intake** â†’ Saved to database
7. **Calendar updates** with âœ“ or âœ—

## Notification Timing

- **After-meal**: Reminder 30 mins before + confirmation at exact time
- **Before-meal**: Reminder 15 mins before + confirmation at exact time

## Database Tables

```sql
push_subscriptions      # Device subscriptions
medicine_confirmations  # Intake history
notification_queue      # Pending notifications (auto-generated by trigger)
```

## Troubleshooting

**No notifications?**
- Check browser permissions
- Verify VAPID keys match between `.env.local` and Supabase secrets
- Check GitHub Actions logs for errors
- Verify subscription exists: `SELECT * FROM push_subscriptions WHERE user_id = '<your-id>'`

**Edge function errors?**
- Check Supabase function logs: `supabase functions logs send-medicine-notifications`
- Verify secrets are set: `supabase secrets list`

**Calendar not updating?**
- Check `/api/confirmations` endpoint
- Verify RLS policies allow user access
- [ ] Set environment variables
- [ ] Apply database migrations
- [ ] Deploy edge function
- [ ] Set up cron job
- [ ] Test on multiple devices
- [ ] Monitor notification delivery rates
- [ ] Set up error alerting

## References

- [Web Push Protocol](https://datatracker.ietf.org/doc/html/rfc8030)
- [VAPID Specification](https://datatracker.ietf.org/doc/html/rfc8292)
- [Service Workers API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Notifications API](https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API)
